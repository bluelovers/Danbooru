module Romakan
  KANA_TO_ROMAJI_MAPPING = {
    # katakana
    "\343\202\241" => "a",
    "\343\202\242" => "a",
    "\343\202\243" => "i",
    "\343\202\244" => "i",
    "\343\202\245" => "u",
    "\343\202\246" => "u",
    "\343\202\247" => "e",
    "\343\202\250" => "e",
    "\343\202\251" => "o",
    "\343\202\252" => "o",
    "\343\202\253" => "ka",
    "\343\202\254" => "ga",
    "\343\202\255" => "ki",
    "\343\202\255\343\203\243" => "kya",
    "\343\202\255\343\203\245" => "kyu",
    "\343\202\255\343\203\247" => "kyo",
    "\343\202\256" => "gi",
    "\343\202\256\343\203\243" => "gya",
    "\343\202\256\343\203\245" => "gyu",
    "\343\202\256\343\203\247" => "gyo",
    "\343\202\257" => "ku",
    "\343\202\260" => "gu",
    "\343\202\261" => "ke",
    "\343\202\262" => "ge",
    "\343\202\263" => "ko",
    "\343\202\264" => "go",
    "\343\202\265" => "sa",
    "\343\202\266" => "za",
    "\343\202\267" => "shi",
    "\343\202\267\343\203\243" => "sha",
    "\343\202\267\343\203\245" => "shu",
    "\343\202\267\343\203\247" => "sho",
    "\343\202\270" => "ji",
    "\343\202\270\343\203\243" => "ja",
    "\343\202\270\343\203\245" => "ju",
    "\343\202\270\343\203\247" => "jo",
    "\343\202\271" => "su",
    "\343\202\272" => "zu",
    "\343\202\273" => "se",
    "\343\202\274" => "ze",
    "\343\202\275" => "so",
    "\343\202\276" => "zo",
    "\343\202\277" => "ta",
    "\343\203\200" => "da",
    "\343\203\201" => "chi",
    "\343\203\201\343\203\243" => "cha",
    "\343\203\201\343\203\245" => "chu",
    "\343\203\201\343\203\247" => "cho",
    "\343\203\202" => "di",
    "\343\203\202\343\203\243" => "dya",
    "\343\203\202\343\203\245" => "dyu",
    "\343\203\202\343\203\247" => "dyo",
    "\343\203\203" => "tsu",
    "\343\203\203\343\202\253" => "kka",
    "\343\203\203\343\202\254" => "gga",
    "\343\203\203\343\202\255" => "kki",
    "\343\203\203\343\202\255\343\203\243" => "kkya",
    "\343\203\203\343\202\255\343\203\245" => "kkyu",
    "\343\203\203\343\202\255\343\203\247" => "kkyo",
    "\343\203\203\343\202\256" => "ggi",
    "\343\203\203\343\202\256\343\203\243" => "ggya",
    "\343\203\203\343\202\256\343\203\245" => "ggyu",
    "\343\203\203\343\202\256\343\203\247" => "ggyo",
    "\343\203\203\343\202\257" => "kku",
    "\343\203\203\343\202\260" => "ggu",
    "\343\203\203\343\202\261" => "kke",
    "\343\203\203\343\202\262" => "gge",
    "\343\203\203\343\202\263" => "kko",
    "\343\203\203\343\202\264" => "ggo",
    "\343\203\203\343\202\265" => "ssa",
    "\343\203\203\343\202\266" => "zza",
    "\343\203\203\343\202\267" => "sshi",
    "\343\203\203\343\202\267\343\203\243" => "ssha",
    "\343\203\203\343\202\267\343\203\245" => "sshu",
    "\343\203\203\343\202\267\343\203\247" => "ssho",
    "\343\203\203\343\202\270" => "jji",
    "\343\203\203\343\202\270\343\203\243" => "jja",
    "\343\203\203\343\202\270\343\203\245" => "jju",
    "\343\203\203\343\202\270\343\203\247" => "jjo",
    "\343\203\203\343\202\271" => "ssu",
    "\343\203\203\343\202\272" => "zzu",
    "\343\203\203\343\202\273" => "sse",
    "\343\203\203\343\202\274" => "zze",
    "\343\203\203\343\202\275" => "sso",
    "\343\203\203\343\202\276" => "zzo",
    "\343\203\203\343\202\277" => "tta",
    "\343\203\203\343\203\200" => "dda",
    "\343\203\203\343\203\201" => "cchi",
    "\343\203\203\343\203\201\343\203\243" => "ccha",
    "\343\203\203\343\203\201\343\203\245" => "cchu",
    "\343\203\203\343\203\201\343\203\247" => "ccho",
    "\343\203\203\343\203\202" => "ddi",
    "\343\203\203\343\203\202\343\203\243" => "ddya",
    "\343\203\203\343\203\202\343\203\245" => "ddyu",
    "\343\203\203\343\203\202\343\203\247" => "ddyo",
    "\343\203\203\343\203\204" => "ttsu",
    "\343\203\203\343\203\205" => "ddu",
    "\343\203\203\343\203\206" => "tte",
    "\343\203\203\343\203\207" => "dde",
    "\343\203\203\343\203\210" => "tto",
    "\343\203\203\343\203\211" => "ddo",
    "\343\203\203\343\203\217" => "hha",
    "\343\203\203\343\203\220" => "bba",
    "\343\203\203\343\203\221" => "ppa",
    "\343\203\203\343\203\222" => "hhi",
    "\343\203\203\343\203\222\343\203\243" => "hhya",
    "\343\203\203\343\203\222\343\203\245" => "hhyu",
    "\343\203\203\343\203\222\343\203\247" => "hhyo",
    "\343\203\203\343\203\223" => "bbi",
    "\343\203\203\343\203\223\343\203\243" => "bbya",
    "\343\203\203\343\203\223\343\203\245" => "bbyu",
    "\343\203\203\343\203\223\343\203\247" => "bbyo",
    "\343\203\203\343\203\224" => "ppi",
    "\343\203\203\343\203\224\343\203\243" => "ppya",
    "\343\203\203\343\203\224\343\203\245" => "ppyu",
    "\343\203\203\343\203\224\343\203\247" => "ppyo",
    "\343\203\203\343\203\225" => "ffu",
    "\343\203\203\343\203\225\343\202\241" => "ffa",
    "\343\203\203\343\203\225\343\202\243" => "ffi",
    "\343\203\203\343\203\225\343\202\247" => "ffe",
    "\343\203\203\343\203\225\343\202\251" => "ffo",
    "\343\203\203\343\203\226" => "bbu",
    "\343\203\203\343\203\227" => "ppu",
    "\343\203\203\343\203\230" => "hhe",
    "\343\203\203\343\203\231" => "bbe",
    "\343\203\203\343\203\232" => "ppe",
    "\343\203\203\343\203\233" => "hho",
    "\343\203\203\343\203\234" => "bbo",
    "\343\203\203\343\203\235" => "ppo",
    "\343\203\203\343\203\244" => "yya",
    "\343\203\203\343\203\246" => "yyu",
    "\343\203\203\343\203\250" => "yyo",
    "\343\203\203\343\203\251" => "rra",
    "\343\203\203\343\203\252" => "rri",
    "\343\203\203\343\203\252\343\203\243" => "rrya",
    "\343\203\203\343\203\252\343\203\245" => "rryu",
    "\343\203\203\343\203\252\343\203\247" => "rryo",
    "\343\203\203\343\203\253" => "rru",
    "\343\203\203\343\203\254" => "rre",
    "\343\203\203\343\203\255" => "rro",
    "\343\203\203\343\203\264" => "vvu",
    "\343\203\203\343\203\264\343\202\241" => "vva",
    "\343\203\203\343\203\264\343\202\243" => "vvi",
    "\343\203\203\343\203\264\343\202\247" => "vve",
    "\343\203\203\343\203\264\343\202\251" => "vvo",
    "\343\203\204" => "tsu",
    "\343\203\205" => "du",
    "\343\203\206" => "te",
    "\343\203\207" => "de",
    "\343\203\210" => "to",
    "\343\203\211" => "do",
    "\343\203\212" => "na",
    "\343\203\213" => "ni",
    "\343\203\213\343\203\243" => "nya",
    "\343\203\213\343\203\245" => "nyu",
    "\343\203\213\343\203\247" => "nyo",
    "\343\203\214" => "nu",
    "\343\203\215" => "ne",
    "\343\203\216" => "no",
    "\343\203\217" => "ha",
    "\343\203\220" => "ba",
    "\343\203\221" => "pa",
    "\343\203\222" => "hi",
    "\343\203\222\343\203\243" => "hya",
    "\343\203\222\343\203\245" => "hyu",
    "\343\203\222\343\203\247" => "hyo",
    "\343\203\223" => "bi",
    "\343\203\223\343\203\243" => "bya",
    "\343\203\223\343\203\245" => "byu",
    "\343\203\223\343\203\247" => "byo",
    "\343\203\224" => "pi",
    "\343\203\224\343\203\243" => "pya",
    "\343\203\224\343\203\245" => "pyu",
    "\343\203\224\343\203\247" => "pyo",
    "\343\203\225" => "fu",
    "\343\203\225\343\202\241" => "fa",
    "\343\203\225\343\202\243" => "fi",
    "\343\203\225\343\202\247" => "fe",
    "\343\203\225\343\202\251" => "fo",
    "\343\203\226" => "bu",
    "\343\203\227" => "pu",
    "\343\203\230" => "he",
    "\343\203\231" => "be",
    "\343\203\232" => "pe",
    "\343\203\233" => "ho",
    "\343\203\234" => "bo",
    "\343\203\235" => "po",
    "\343\203\236" => "ma",
    "\343\203\237" => "mi",
    "\343\203\237\343\203\243" => "mya",
    "\343\203\237\343\203\245" => "myu",
    "\343\203\237\343\203\247" => "myo",
    "\343\203\240" => "mu",
    "\343\203\241" => "me",
    "\343\203\242" => "mo",
    "\343\203\243" => "ya",
    "\343\203\244" => "ya",
    "\343\203\245" => "yu",
    "\343\203\246" => "yu",
    "\343\203\247" => "yo",
    "\343\203\250" => "yo",
    "\343\203\251" => "ra",
    "\343\203\252" => "ri",
    "\343\203\252\343\203\243" => "rya",
    "\343\203\252\343\203\245" => "ryu",
    "\343\203\252\343\203\247" => "ryo",
    "\343\203\253" => "ru",
    "\343\203\254" => "re",
    "\343\203\255" => "ro",
    "\343\203\256" => "wa",
    "\343\203\257" => "wa",
    "\343\203\260" => "i",
    "\343\203\261" => "e",
    "\343\203\262" => "wo",
    "\343\203\263" => "n",
    "\343\203\263\343\202\242" => "n'a",
    "\343\203\263\343\202\244" => "n'i",
    "\343\203\263\343\202\246" => "n'u",
    "\343\203\263\343\202\250" => "n'e",
    "\343\203\263\343\202\252" => "n'o",
    "\343\203\264" => "vu",
    "\343\203\264\343\202\241" => "va",
    "\343\203\264\343\202\243" => "vi",
    "\343\203\264\343\202\247" => "ve",
    "\343\203\264\343\202\251" => "vo",
    "\343\203\265" => "ka",
    "\343\203\266" => "ke",

    # hiragana
    "\343\201\201" => "a",
    "\343\201\202" => "a",
    "\343\201\203" => "i",
    "\343\201\204" => "i",
    "\343\201\205" => "u",
    "\343\201\206" => "u",
    "\343\201\206\343\202\233" => "vu",
    "\343\201\206\343\202\233\343\201\201" => "va",
    "\343\201\206\343\202\233\343\201\203" => "vi",
    "\343\201\206\343\202\233\343\201\207" => "ve",
    "\343\201\206\343\202\233\343\201\211" => "vo",
    "\343\201\207" => "e",
    "\343\201\210" => "e",
    "\343\201\211" => "o",
    "\343\201\212" => "o",
    "\343\201\213" => "ka",
    "\343\201\214" => "ga",
    "\343\201\215" => "ki",
    "\343\201\215\343\202\203" => "kya",
    "\343\201\215\343\202\205" => "kyu",
    "\343\201\215\343\202\207" => "kyo",
    "\343\201\216" => "gi",
    "\343\201\216\343\202\203" => "gya",
    "\343\201\216\343\202\205" => "gyu",
    "\343\201\216\343\202\207" => "gyo",
    "\343\201\217" => "ku",
    "\343\201\220" => "gu",
    "\343\201\221" => "ke",
    "\343\201\222" => "ge",
    "\343\201\223" => "ko",
    "\343\201\224" => "go",
    "\343\201\225" => "sa",
    "\343\201\226" => "za",
    "\343\201\227" => "shi",
    "\343\201\227\343\202\203" => "sha",
    "\343\201\227\343\202\205" => "shu",
    "\343\201\227\343\202\207" => "sho",
    "\343\201\230" => "ji",
    "\343\201\230\343\202\203" => "ja",
    "\343\201\230\343\202\205" => "ju",
    "\343\201\230\343\202\207" => "jo",
    "\343\201\231" => "su",
    "\343\201\232" => "zu",
    "\343\201\233" => "se",
    "\343\201\234" => "ze",
    "\343\201\235" => "so",
    "\343\201\236" => "zo",
    "\343\201\237" => "ta",
    "\343\201\240" => "da",
    "\343\201\241" => "chi",
    "\343\201\241\343\202\203" => "cha",
    "\343\201\241\343\202\205" => "chu",
    "\343\201\241\343\202\207" => "cho",
    "\343\201\242" => "di",
    "\343\201\242\343\202\203" => "dya",
    "\343\201\242\343\202\205" => "dyu",
    "\343\201\242\343\202\207" => "dyo",
    "\343\201\243" => "tsu",
    "\343\201\243\343\201\206\343\202\233" => "vvu",
    "\343\201\243\343\201\206\343\202\233\343\201\201" => "vva",
    "\343\201\243\343\201\206\343\202\233\343\201\203" => "vvi",
    "\343\201\243\343\201\206\343\202\233\343\201\207" => "vve",
    "\343\201\243\343\201\206\343\202\233\343\201\211" => "vvo",
    "\343\201\243\343\201\213" => "kka",
    "\343\201\243\343\201\214" => "gga",
    "\343\201\243\343\201\215" => "kki",
    "\343\201\243\343\201\215\343\202\203" => "kkya",
    "\343\201\243\343\201\215\343\202\205" => "kkyu",
    "\343\201\243\343\201\215\343\202\207" => "kkyo",
    "\343\201\243\343\201\216" => "ggi",
    "\343\201\243\343\201\216\343\202\203" => "ggya",
    "\343\201\243\343\201\216\343\202\205" => "ggyu",
    "\343\201\243\343\201\216\343\202\207" => "ggyo",
    "\343\201\243\343\201\217" => "kku",
    "\343\201\243\343\201\220" => "ggu",
    "\343\201\243\343\201\221" => "kke",
    "\343\201\243\343\201\222" => "gge",
    "\343\201\243\343\201\223" => "kko",
    "\343\201\243\343\201\224" => "ggo",
    "\343\201\243\343\201\225" => "ssa",
    "\343\201\243\343\201\226" => "zza",
    "\343\201\243\343\201\227" => "sshi",
    "\343\201\243\343\201\227\343\202\203" => "ssha",
    "\343\201\243\343\201\227\343\202\205" => "sshu",
    "\343\201\243\343\201\227\343\202\207" => "ssho",
    "\343\201\243\343\201\230" => "jji",
    "\343\201\243\343\201\230\343\202\203" => "jja",
    "\343\201\243\343\201\230\343\202\205" => "jju",
    "\343\201\243\343\201\230\343\202\207" => "jjo",
    "\343\201\243\343\201\231" => "ssu",
    "\343\201\243\343\201\232" => "zzu",
    "\343\201\243\343\201\233" => "sse",
    "\343\201\243\343\201\234" => "zze",
    "\343\201\243\343\201\235" => "sso",
    "\343\201\243\343\201\236" => "zzo",
    "\343\201\243\343\201\237" => "tta",
    "\343\201\243\343\201\240" => "dda",
    "\343\201\243\343\201\241" => "cchi",
    "\343\201\243\343\201\241\343\202\203" => "ccha",
    "\343\201\243\343\201\241\343\202\205" => "cchu",
    "\343\201\243\343\201\241\343\202\207" => "ccho",
    "\343\201\243\343\201\242" => "ddi",
    "\343\201\243\343\201\242\343\202\203" => "ddya",
    "\343\201\243\343\201\242\343\202\205" => "ddyu",
    "\343\201\243\343\201\242\343\202\207" => "ddyo",
    "\343\201\243\343\201\244" => "ttsu",
    "\343\201\243\343\201\245" => "ddu",
    "\343\201\243\343\201\246" => "tte",
    "\343\201\243\343\201\247" => "dde",
    "\343\201\243\343\201\250" => "tto",
    "\343\201\243\343\201\251" => "ddo",
    "\343\201\243\343\201\257" => "hha",
    "\343\201\243\343\201\260" => "bba",
    "\343\201\243\343\201\261" => "ppa",
    "\343\201\243\343\201\262" => "hhi",
    "\343\201\243\343\201\262\343\202\203" => "hhya",
    "\343\201\243\343\201\262\343\202\205" => "hhyu",
    "\343\201\243\343\201\262\343\202\207" => "hhyo",
    "\343\201\243\343\201\263" => "bbi",
    "\343\201\243\343\201\263\343\202\203" => "bbya",
    "\343\201\243\343\201\263\343\202\205" => "bbyu",
    "\343\201\243\343\201\263\343\202\207" => "bbyo",
    "\343\201\243\343\201\264" => "ppi",
    "\343\201\243\343\201\264\343\202\203" => "ppya",
    "\343\201\243\343\201\264\343\202\205" => "ppyu",
    "\343\201\243\343\201\264\343\202\207" => "ppyo",
    "\343\201\243\343\201\265" => "ffu",
    "\343\201\243\343\201\265\343\201\201" => "ffa",
    "\343\201\243\343\201\265\343\201\203" => "ffi",
    "\343\201\243\343\201\265\343\201\207" => "ffe",
    "\343\201\243\343\201\265\343\201\211" => "ffo",
    "\343\201\243\343\201\266" => "bbu",
    "\343\201\243\343\201\267" => "ppu",
    "\343\201\243\343\201\270" => "hhe",
    "\343\201\243\343\201\271" => "bbe",
    "\343\201\243\343\201\272" => "ppe",
    "\343\201\243\343\201\273" => "hho",
    "\343\201\243\343\201\274" => "bbo",
    "\343\201\243\343\201\275" => "ppo",
    "\343\201\243\343\202\204" => "yya",
    "\343\201\243\343\202\206" => "yyu",
    "\343\201\243\343\202\210" => "yyo",
    "\343\201\243\343\202\211" => "rra",
    "\343\201\243\343\202\212" => "rri",
    "\343\201\243\343\202\212\343\202\203" => "rrya",
    "\343\201\243\343\202\212\343\202\205" => "rryu",
    "\343\201\243\343\202\212\343\202\207" => "rryo",
    "\343\201\243\343\202\213" => "rru",
    "\343\201\243\343\202\214" => "rre",
    "\343\201\243\343\202\215" => "rro",
    "\343\201\244" => "tsu",
    "\343\201\245" => "du",
    "\343\201\246" => "te",
    "\343\201\247" => "de",
    "\343\201\250" => "to",
    "\343\201\251" => "do",
    "\343\201\252" => "na",
    "\343\201\253" => "ni",
    "\343\201\253\343\202\203" => "nya",
    "\343\201\253\343\202\205" => "nyu",
    "\343\201\253\343\202\207" => "nyo",
    "\343\201\254" => "nu",
    "\343\201\255" => "ne",
    "\343\201\256" => "no",
    "\343\201\257" => "ha",
    "\343\201\260" => "ba",
    "\343\201\261" => "pa",
    "\343\201\262" => "hi",
    "\343\201\262\343\202\203" => "hya",
    "\343\201\262\343\202\205" => "hyu",
    "\343\201\262\343\202\207" => "hyo",
    "\343\201\263" => "bi",
    "\343\201\263\343\202\203" => "bya",
    "\343\201\263\343\202\205" => "byu",
    "\343\201\263\343\202\207" => "byo",
    "\343\201\264" => "pi",
    "\343\201\264\343\202\203" => "pya",
    "\343\201\264\343\202\205" => "pyu",
    "\343\201\264\343\202\207" => "pyo",
    "\343\201\265" => "fu",
    "\343\201\265\343\201\201" => "fa",
    "\343\201\265\343\201\203" => "fi",
    "\343\201\265\343\201\207" => "fe",
    "\343\201\265\343\201\211" => "fo",
    "\343\201\266" => "bu",
    "\343\201\267" => "pu",
    "\343\201\270" => "he",
    "\343\201\271" => "be",
    "\343\201\272" => "pe",
    "\343\201\273" => "ho",
    "\343\201\274" => "bo",
    "\343\201\275" => "po",
    "\343\201\276" => "ma",
    "\343\201\277" => "mi",
    "\343\201\277\343\202\203" => "mya",
    "\343\201\277\343\202\205" => "myu",
    "\343\201\277\343\202\207" => "myo",
    "\343\202\200" => "mu",
    "\343\202\201" => "me",
    "\343\202\202" => "mo",
    "\343\202\203" => "ya",
    "\343\202\204" => "ya",
    "\343\202\205" => "yu",
    "\343\202\206" => "yu",
    "\343\202\207" => "yo",
    "\343\202\210" => "yo",
    "\343\202\211" => "ra",
    "\343\202\212" => "ri",
    "\343\202\212\343\202\203" => "rya",
    "\343\202\212\343\202\205" => "ryu",
    "\343\202\212\343\202\207" => "ryo",
    "\343\202\213" => "ru",
    "\343\202\214" => "re",
    "\343\202\215" => "ro",
    "\343\202\216" => "wa",
    "\343\202\217" => "wa",
    "\343\202\220" => "i",
    "\343\202\221" => "e",
    "\343\202\222" => "wo",
    "\343\202\223" => "n",
    "\343\202\223\343\201\202" => "n'a",
    "\343\202\223\343\201\204" => "n'i",
    "\343\202\223\343\201\206" => "n'u",
    "\343\202\223\343\201\210" => "n'e",
    "\343\202\223\343\201\212" => "n'o",
    
    "\343\203\274" => "-"
  }

  KANA_REGEXP = Regexp.compile("(" + KANA_TO_ROMAJI_MAPPING.keys.sort {|a, b| b.size <=> a.size}.join("|") + ")")

  def normalize_double_n(str)
    str.gsub(/nn/, "n'").gsub(/n'(?=[^aiueoyn]|$)/, "n")
  end

  def normalize_dash(str)
    str.gsub(/e-/, "ei").gsub(/([aiou])-/) do
      $1 + $1
    end
  end

  def kana_to_romaji(str)
    str = str.gsub(KANA_REGEXP) do
      KANA_TO_ROMAJI_MAPPING[$1] || $1
    end
  
    str = normalize_double_n(str)
    str = normalize_dash(str)
  end

  def kanji_to_romaji(str)
    kana_to_romaji(kanji_to_kana(str))
  end
  
  module_function :kanji_to_romaji
  module_function :normalize_double_n
  module_function :normalize_dash
  module_function :kana_to_romaji
end
