<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: Post</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">Post</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/models/post_rb.html">
                app/models/post.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                ActiveRecord::Base
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000074">append_tags</a>&nbsp;&nbsp;
      <a href="#M000094">author</a>&nbsp;&nbsp;
      <a href="#M000083">auto_download</a>&nbsp;&nbsp;
      <a href="#M000077">commit_tags</a>&nbsp;&nbsp;
      <a href="#M000082">delete_file</a>&nbsp;&nbsp;
      <a href="#M000103">escape_javascript</a>&nbsp;&nbsp;
      <a href="#M000073">fast_count</a>&nbsp;&nbsp;
      <a href="#M000084">file=</a>&nbsp;&nbsp;
      <a href="#M000085">file_name</a>&nbsp;&nbsp;
      <a href="#M000086">file_path</a>&nbsp;&nbsp;
      <a href="#M000087">file_url</a>&nbsp;&nbsp;
      <a href="#M000104">find_ext</a>&nbsp;&nbsp;
      <a href="#M000092">flash?</a>&nbsp;&nbsp;
      <a href="#M000102">generate_attributes</a>&nbsp;&nbsp;
      <a href="#M000079">generate_hash</a>&nbsp;&nbsp;
      <a href="#M000081">generate_preview</a>&nbsp;&nbsp;
      <a href="#M000098">generate_sql</a>&nbsp;&nbsp;
      <a href="#M000097">generate_sql__range_helper</a>&nbsp;&nbsp;
      <a href="#M000090">get_image_dimensions</a>&nbsp;&nbsp;
      <a href="#M000091">image?</a>&nbsp;&nbsp;
      <a href="#M000099">pretty_rating</a>&nbsp;&nbsp;
      <a href="#M000088">preview_path</a>&nbsp;&nbsp;
      <a href="#M000089">preview_url</a>&nbsp;&nbsp;
      <a href="#M000076">rating=</a>&nbsp;&nbsp;
      <a href="#M000080">rename_file</a>&nbsp;&nbsp;
      <a href="#M000093">size</a>&nbsp;&nbsp;
      <a href="#M000075">tags=</a>&nbsp;&nbsp;
      <a href="#M000078">tempfile_path</a>&nbsp;&nbsp;
      <a href="#M000100">to_json</a>&nbsp;&nbsp;
      <a href="#M000101">to_xml</a>&nbsp;&nbsp;
      <a href="#M000095">update_neighbor_links_on_create</a>&nbsp;&nbsp;
      <a href="#M000096">update_neighbor_links_on_destroy</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">updater_ip_addr</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">updater_user_id</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000073" class="method-detail">
        <a name="M000073"></a>

        <div class="method-heading">
          <a href="#M000073" class="method-signature">
          <span class="method-name">fast_count</span><span class="method-args">(tags = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000073-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000073-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/post.rb, line 23</span>
23:         <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">fast_count</span>(<span class="ruby-identifier">tags</span> = <span class="ruby-keyword kw">nil</span>)
24:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">blank?</span>
25:                         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_value</span>(<span class="ruby-value str">&quot;SELECT row_count FROM table_data WHERE name = 'posts'&quot;</span>).<span class="ruby-identifier">to_i</span>
26:                 <span class="ruby-keyword kw">else</span>
27:                         <span class="ruby-identifier">c</span> = <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_value</span>(<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-value str">&quot;SELECT post_count FROM tags WHERE name = ?&quot;</span>, <span class="ruby-identifier">tags</span>])).<span class="ruby-identifier">to_i</span>
28:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
29:                                 <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Post</span>.<span class="ruby-identifier">count_by_sql</span>(<span class="ruby-constant">Post</span>.<span class="ruby-identifier">generate_sql</span>(<span class="ruby-identifier">tags</span>, <span class="ruby-identifier">:count</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>))
30:                         <span class="ruby-keyword kw">else</span>
31:                                 <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">c</span>
32:                         <span class="ruby-keyword kw">end</span>
33:                 <span class="ruby-keyword kw">end</span>
34:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000098" class="method-detail">
        <a name="M000098"></a>

        <div class="method-heading">
          <a href="#M000098" class="method-signature">
          <span class="method-name">generate_sql</span><span class="method-args">(q, options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000098-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000098-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 310</span>
310:         <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">generate_sql</span>(<span class="ruby-identifier">q</span>, <span class="ruby-identifier">options</span> = {})
311:                 <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">q</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>)
312:                         <span class="ruby-identifier">q</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">parse_query</span>(<span class="ruby-identifier">q</span>)
313:                 <span class="ruby-keyword kw">end</span>
314: 
315:                 <span class="ruby-identifier">conditions</span> = []
316:                 <span class="ruby-identifier">from</span> = [<span class="ruby-value str">&quot;posts p&quot;</span>]
317:                 <span class="ruby-identifier">params</span> = []
318: 
319:                 <span class="ruby-identifier">generate_sql__range_helper</span>(<span class="ruby-identifier">q</span>[<span class="ruby-identifier">:post_id</span>], <span class="ruby-value str">&quot;p.id&quot;</span>, <span class="ruby-identifier">conditions</span>, <span class="ruby-identifier">params</span>)
320:                 <span class="ruby-identifier">generate_sql__range_helper</span>(<span class="ruby-identifier">q</span>[<span class="ruby-identifier">:width</span>], <span class="ruby-value str">&quot;p.width&quot;</span>, <span class="ruby-identifier">conditions</span>, <span class="ruby-identifier">params</span>)
321:                 <span class="ruby-identifier">generate_sql__range_helper</span>(<span class="ruby-identifier">q</span>[<span class="ruby-identifier">:height</span>], <span class="ruby-value str">&quot;p.height&quot;</span>, <span class="ruby-identifier">conditions</span>, <span class="ruby-identifier">params</span>)
322:                 <span class="ruby-identifier">generate_sql__range_helper</span>(<span class="ruby-identifier">q</span>[<span class="ruby-identifier">:score</span>], <span class="ruby-value str">&quot;p.score&quot;</span>, <span class="ruby-identifier">conditions</span>, <span class="ruby-identifier">params</span>)
323: 
324:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:md5</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
325:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.md5 = ?&quot;</span>
326:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:md5</span>]
327:                 <span class="ruby-keyword kw">end</span>
328: 
329:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:source</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
330:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.source ILIKE ? ESCAPE '\\\\'&quot;</span>
331:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:source</span>]
332:                 <span class="ruby-keyword kw">end</span>
333: 
334:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:fav</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
335:                         <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;favorites f&quot;</span>
336:                         <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;users u1&quot;</span>
337:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.id = f.post_id AND f.user_id = u1.id AND lower(u1.name) = lower(?)&quot;</span>
338:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:fav</span>]
339:                 <span class="ruby-keyword kw">end</span>
340: 
341:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:user</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
342:                         <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;users u2&quot;</span>
343:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.user_id = u2.id AND lower(u2.name) = lower(?)&quot;</span>
344:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:user</span>]
345:                 <span class="ruby-keyword kw">end</span>
346: 
347:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>].<span class="ruby-identifier">any?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:include</span>].<span class="ruby-identifier">any?</span>
348:                         <span class="ruby-identifier">conditions2</span> = []
349:                         
350:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:include</span>].<span class="ruby-identifier">any?</span>
351:                                 <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;posts_tags pt0&quot;</span>
352:                                 <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;tags t0&quot;</span>
353:                                 <span class="ruby-identifier">conditions2</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;(p.id = pt0.post_id AND t0.id = pt0.tag_id AND t0.name IN (?))&quot;</span>
354:                                 <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">q</span>[<span class="ruby-identifier">:include</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>])
355:                         <span class="ruby-keyword kw">else</span>
356:                                 <span class="ruby-identifier">conditions3</span> = []
357: 
358:                                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>].<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
359:                                         <span class="ruby-identifier">count</span> = <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_value</span>(<span class="ruby-constant">Post</span>.<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-value str">&quot;SELECT post_count FROM tags WHERE name = ?&quot;</span>, <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>][<span class="ruby-value">0</span>]])).<span class="ruby-identifier">to_i</span>
360:                                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">count</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">100</span>
361:                                                 <span class="ruby-comment cmt"># 96% of the tags have a post count below 100. it makes sense to optimize for this common case, then.</span>
362:                                                 <span class="ruby-comment cmt"># for tags with low post counts, using &quot;p.id in (...)&quot; is much faster than relying on a join.</span>
363:                                                 <span class="ruby-identifier">conditions3</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.id IN (SELECT pt1.post_id FROM posts_tags pt1 WHERE pt1.tag_id = (SELECT id FROM tags WHERE name = ?))&quot;</span>
364:                                         <span class="ruby-keyword kw">else</span>
365:                                                 <span class="ruby-comment cmt"># On the other hand, for extremely populated tags (the top 5%) this method is much faster.</span>
366:                                                 <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;posts_tags pt1&quot;</span>
367:                                                 <span class="ruby-identifier">conditions3</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.id = pt1.post_id AND pt1.tag_id = (SELECT id FROM tags WHERE name = ?)&quot;</span>
368:                                         <span class="ruby-keyword kw">end</span>
369:                                 <span class="ruby-keyword kw">else</span>
370:                                         (<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>].<span class="ruby-identifier">size</span>).<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;posts_tags pt#{i}&quot;</span>}
371:                                         <span class="ruby-identifier">conditions3</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.id = pt1.post_id&quot;</span>
372:                                         (<span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>].<span class="ruby-identifier">size</span>).<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">conditions3</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;pt1.post_id = pt#{i}.post_id&quot;</span>}
373:                                         (<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>].<span class="ruby-identifier">size</span>).<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">conditions3</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;pt#{i}.tag_id = (SELECT id FROM tags WHERE name = ?)&quot;</span>}
374:                                 <span class="ruby-keyword kw">end</span>
375: 
376:                                 <span class="ruby-identifier">params</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>]
377:                                 <span class="ruby-identifier">conditions2</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;(&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">conditions3</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot; AND &quot;</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;)&quot;</span>
378:                         <span class="ruby-keyword kw">end</span>
379: 
380:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;(&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">conditions2</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot; OR &quot;</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;)&quot;</span>
381:                 <span class="ruby-keyword kw">end</span>
382: 
383:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:exclude</span>].<span class="ruby-identifier">any?</span>
384:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.id NOT IN (SELECT pt_.post_id FROM posts_tags pt_, tags t_ WHERE pt_.tag_id = t_.id AND t_.name IN (?))&quot;</span>
385:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:exclude</span>]
386:                 <span class="ruby-keyword kw">end</span>
387: 
388:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:rating</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
389:                         <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:rating</span>].<span class="ruby-identifier">downcase</span>
390:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;safe&quot;</span>
391:                                 <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.rating = 's'&quot;</span>
392: 
393:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;questionable&quot;</span>
394:                                 <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.rating = 'q'&quot;</span>
395: 
396:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;explicit&quot;</span>
397:                                 <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.rating = 'e'&quot;</span>
398:                         <span class="ruby-keyword kw">end</span>
399:                 <span class="ruby-keyword kw">end</span>
400: 
401:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:unlocked_rating</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword kw">true</span>
402:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.is_rating_locked = FALSE&quot;</span>
403:                 <span class="ruby-keyword kw">end</span>
404: 
405:                 <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;TRUE&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">empty?</span>
406: 
407:                 <span class="ruby-identifier">sql</span> = <span class="ruby-value str">&quot;SELECT &quot;</span>
408:                 
409:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:count</span>]
410:                         <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;COUNT(p)&quot;</span>
411:                 <span class="ruby-keyword kw">else</span>
412:                         <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.*&quot;</span>
413:                 <span class="ruby-keyword kw">end</span>
414: 
415:                 <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; FROM &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">from</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;, &quot;</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; WHERE &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot; AND &quot;</span>)
416: 
417:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:order</span>]
418:                         <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; ORDER BY &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:order</span>]
419:                 <span class="ruby-keyword kw">end</span>
420: 
421:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:limit</span>]
422:                         <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; LIMIT &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:limit</span>].<span class="ruby-identifier">to_s</span>
423:                 <span class="ruby-keyword kw">end</span>
424: 
425:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:offset</span>]
426:                         <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; OFFSET &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:offset</span>].<span class="ruby-identifier">to_s</span>
427:                 <span class="ruby-keyword kw">end</span>
428: 
429:                 <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Post</span>.<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-identifier">sql</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">params</span>])
430:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000097" class="method-detail">
        <a name="M000097"></a>

        <div class="method-heading">
          <a href="#M000097" class="method-signature">
          <span class="method-name">generate_sql__range_helper</span><span class="method-args">(arr, field, c, p)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000097-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000097-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 286</span>
286:         <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">generate_sql__range_helper</span>(<span class="ruby-identifier">arr</span>, <span class="ruby-identifier">field</span>, <span class="ruby-identifier">c</span>, <span class="ruby-identifier">p</span>)
287:                 <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">arr</span>[<span class="ruby-value">0</span>]
288:                 <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:eq</span>
289:                         <span class="ruby-identifier">c</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{field} = ?&quot;</span>
290:                         <span class="ruby-identifier">p</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arr</span>[<span class="ruby-value">1</span>]
291: 
292:                 <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:gt</span>
293:                         <span class="ruby-identifier">c</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{field} &gt;= ?&quot;</span>
294:                         <span class="ruby-identifier">p</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arr</span>[<span class="ruby-value">1</span>]
295: 
296:                 <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:lt</span>
297:                         <span class="ruby-identifier">c</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{field} &lt;= ?&quot;</span>
298:                         <span class="ruby-identifier">p</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arr</span>[<span class="ruby-value">1</span>]
299: 
300:                 <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:between</span>
301:                         <span class="ruby-identifier">c</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{field} BETWEEN ? AND ?&quot;</span>
302:                         <span class="ruby-identifier">p</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arr</span>[<span class="ruby-value">1</span>]
303:                         <span class="ruby-identifier">p</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arr</span>[<span class="ruby-value">2</span>]
304: 
305:                 <span class="ruby-keyword kw">else</span>
306:                         <span class="ruby-comment cmt"># do nothing</span>
307:                 <span class="ruby-keyword kw">end</span>
308:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000074" class="method-detail">
        <a name="M000074"></a>

        <div class="method-heading">
          <a href="#M000074" class="method-signature">
          <span class="method-name">append_tags</span><span class="method-args">(t)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000074-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000074-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/post.rb, line 36</span>
36:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">append_tags</span>(<span class="ruby-identifier">t</span>)
37:                 <span class="ruby-ivar">@tag_cache</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">cached_tags</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">t</span>
38:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000094" class="method-detail">
        <a name="M000094"></a>

        <div class="method-heading">
          <a href="#M000094" class="method-signature">
          <span class="method-name">author</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns either the <a href="Post.html#M000094">author</a>&#8216;s name or
the default guest name.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000094-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000094-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 246</span>
246:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">author</span>
247:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@author</span>
248:                         <span class="ruby-ivar">@author</span>
249:                 <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">user_id</span>
250:                         <span class="ruby-ivar">@author</span> = <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_value</span>(<span class="ruby-node">&quot;SELECT name FROM users WHERE id = #{self.user_id}&quot;</span>)
251:                         <span class="ruby-ivar">@author</span>
252:                 <span class="ruby-keyword kw">else</span>
253:                         <span class="ruby-constant">CONFIG</span>[<span class="ruby-value str">&quot;default_guest_name&quot;</span>]
254:                 <span class="ruby-keyword kw">end</span>
255:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000083" class="method-detail">
        <a name="M000083"></a>

        <div class="method-heading">
          <a href="#M000083" class="method-signature">
          <span class="method-name">auto_download</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
<a href="Post.html#M000083">auto_download</a> automatically downloads from
the source url if it&#8216;s a URL
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000083-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000083-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 150</span>
150:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">auto_download</span>
151:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">source</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^http/</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">file_ext</span>.<span class="ruby-identifier">blank?</span>)
152: 
153:                 <span class="ruby-keyword kw">begin</span>
154:                         <span class="ruby-identifier">img</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">get</span>(<span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">source</span>))
155:                         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file_ext</span> = <span class="ruby-identifier">find_ext</span>(<span class="ruby-identifier">source</span>)
156:                         <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">tempfile_path</span>, <span class="ruby-value str">'wb'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">out</span><span class="ruby-operator">|</span>
157:                                 <span class="ruby-identifier">out</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">img</span>)
158:                         <span class="ruby-keyword kw">end</span>
159:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">x</span>
160:                         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_f</span>(<span class="ruby-identifier">tempfile_path</span>)
161:                         <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span> <span class="ruby-value str">&quot;source&quot;</span>, <span class="ruby-node">&quot;couldn't be opened: #{x}&quot;</span>
162:                         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
163:                 <span class="ruby-keyword kw">end</span>
164:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000077" class="method-detail">
        <a name="M000077"></a>

        <div class="method-heading">
          <a href="#M000077" class="method-signature">
          <span class="method-name">commit_tags</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
commits the tag changes to the database
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000077-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000077-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 64</span>
 64:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">commit_tags</span>
 65:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@tag_cache</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
 66:                         <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">new_record?</span>
 67:                                 <span class="ruby-ivar">@tag_cache</span> = <span class="ruby-value str">&quot;tagme&quot;</span>
 68:                         <span class="ruby-keyword kw">else</span>
 69:                                 <span class="ruby-keyword kw">return</span>
 70:                         <span class="ruby-keyword kw">end</span>
 71:                 <span class="ruby-keyword kw">end</span>
 72: 
 73:                 <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;IP address not set&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">updater_ip_addr</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
 74: 
 75:                 <span class="ruby-ivar">@tag_cache</span> = <span class="ruby-value str">&quot;tagme&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@tag_cache</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;&quot;</span>
 76:                 <span class="ruby-ivar">@tag_cache</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">scan_tags</span>(<span class="ruby-ivar">@tag_cache</span>)
 77:                 <span class="ruby-ivar">@tag_cache</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">to_aliased</span>(<span class="ruby-ivar">@tag_cache</span>).<span class="ruby-identifier">uniq</span>
 78:                 <span class="ruby-ivar">@tag_cache</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">with_parents</span>(<span class="ruby-ivar">@tag_cache</span>).<span class="ruby-identifier">uniq</span>
 79: 
 80:                 <span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
 81:                         <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;DELETE FROM posts_tags WHERE post_id = #{id}&quot;</span>)
 82:                         <span class="ruby-identifier">tag_list</span> = []
 83: 
 84:                         <span class="ruby-ivar">@tag_cache</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
 85:                                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^rating:(.+)/</span>
 86:                                         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">rating</span> = <span class="ruby-identifier">$1</span>
 87:                                 <span class="ruby-keyword kw">else</span>
 88:                                         <span class="ruby-identifier">record</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">find_or_create_by_name</span>(<span class="ruby-identifier">t</span>)
 89:                                         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">tag_list</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">record</span>.<span class="ruby-identifier">name</span>)
 90:                                                 <span class="ruby-identifier">tag_list</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">name</span>
 91:                                                 <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;INSERT INTO posts_tags (post_id, tag_id) VALUES (#{id}, #{record.id})&quot;</span>)
 92:                                         <span class="ruby-keyword kw">end</span>
 93:                                 <span class="ruby-keyword kw">end</span>
 94:                         <span class="ruby-keyword kw">end</span>
 95:                         
 96:                         <span class="ruby-identifier">tag_string</span> = <span class="ruby-identifier">tag_list</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot; &quot;</span>)
 97: 
 98:                         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_value</span>(<span class="ruby-node">&quot;SELECT tags FROM post_tag_histories WHERE post_id = #{id} ORDER BY id DESC LIMIT 1&quot;</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">tag_string</span>
 99:                                 <span class="ruby-constant">PostTagHistory</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">:post_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:tags</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">tag_string</span>, <span class="ruby-identifier">:user_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">updater_user_id</span>, <span class="ruby-identifier">:ip_addr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">updater_ip_addr</span>)
100:                         <span class="ruby-keyword kw">end</span>
101:                         <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-constant">Post</span>.<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-node">&quot;UPDATE posts SET cached_tags = ? WHERE id = #{id}&quot;</span>, <span class="ruby-identifier">tag_string</span>]))
102:                 <span class="ruby-keyword kw">end</span>
103:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000082" class="method-detail">
        <a name="M000082"></a>

        <div class="method-heading">
          <a href="#M000082" class="method-signature">
          <span class="method-name">delete_file</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
<a href="Post.html#M000082">delete_file</a> removes the post and its
preview from the file system.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000082-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000082-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 144</span>
144:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_file</span>
145:                 <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_f</span>(<span class="ruby-identifier">file_path</span>)
146:                 <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_f</span>(<span class="ruby-identifier">preview_path</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">image?</span>
147:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000084" class="method-detail">
        <a name="M000084"></a>

        <div class="method-heading">
          <a href="#M000084" class="method-signature">
          <span class="method-name">file=</span><span class="method-args">(f)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
<a href="Post.html#M000084">file=</a> assigns a CGI file to the post. This
writes the file to disk and generates a unique file name.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000084-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000084-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 167</span>
167:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">file=</span>(<span class="ruby-identifier">f</span>)
168:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
169: 
170:                 <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file_ext</span> = <span class="ruby-identifier">find_ext</span>(<span class="ruby-identifier">f</span>.<span class="ruby-identifier">original_filename</span>)
171: 
172:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">local_path</span>
173:                         <span class="ruby-comment cmt"># Large files are stored in the temp directory, so instead of</span>
174:                         <span class="ruby-comment cmt"># reading/rewriting through Ruby, just rely on system calls to</span>
175:                         <span class="ruby-comment cmt"># copy the file to danbooru's directory.</span>
176:                         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">cp</span>(<span class="ruby-identifier">f</span>.<span class="ruby-identifier">local_path</span>, <span class="ruby-identifier">tempfile_path</span>)
177:                 <span class="ruby-keyword kw">else</span>
178:                         <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">tempfile_path</span>, <span class="ruby-value str">'wb'</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">nf</span><span class="ruby-operator">|</span> <span class="ruby-identifier">nf</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span>)}
179:                 <span class="ruby-keyword kw">end</span>
180:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000085" class="method-detail">
        <a name="M000085"></a>

        <div class="method-heading">
          <a href="#M000085" class="method-signature">
          <span class="method-name">file_name</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000085-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000085-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 182</span>
182:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">file_name</span>
183:                 <span class="ruby-identifier">md5</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;.&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">file_ext</span>
184:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000086" class="method-detail">
        <a name="M000086"></a>

        <div class="method-heading">
          <a href="#M000086" class="method-signature">
          <span class="method-name">file_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the absolute path to the post.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000086-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000086-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 187</span>
187:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">file_path</span>
188:                 <span class="ruby-node">&quot;#{RAILS_ROOT}/public/data/%s/%s/%s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">md5</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span>[<span class="ruby-value">2</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">file_name</span>]
189:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000087" class="method-detail">
        <a name="M000087"></a>

        <div class="method-heading">
          <a href="#M000087" class="method-signature">
          <span class="method-name">file_url</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the URL for the post
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000087-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000087-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 192</span>
192:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">file_url</span>
193:                 <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">method_defined?</span> <span class="ruby-identifier">:file_url_alt</span>
194:                         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">file_url_alt</span>()
195:                 <span class="ruby-keyword kw">end</span>
196: 
197:                 <span class="ruby-value str">&quot;http://&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">CONFIG</span>[<span class="ruby-value str">&quot;server_host&quot;</span>] <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;/data/%s/%s/%s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">md5</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span>[<span class="ruby-value">2</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">file_name</span>]
198:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000092" class="method-detail">
        <a name="M000092"></a>

        <div class="method-heading">
          <a href="#M000092" class="method-signature">
          <span class="method-name">flash?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if the post is a Flash movie.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000092-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000092-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 236</span>
236:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">flash?</span>
237:                 <span class="ruby-identifier">file_ext</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;swf&quot;</span>
238:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000079" class="method-detail">
        <a name="M000079"></a>

        <div class="method-heading">
          <a href="#M000079" class="method-signature">
          <span class="method-name">generate_hash</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Generates a MD5 hash for the file
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000079-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000079-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 110</span>
110:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">generate_hash</span>
111:                 <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">md5</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">tempfile_path</span>, <span class="ruby-value str">'rb'</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">fp</span><span class="ruby-operator">|</span> <span class="ruby-constant">Digest</span><span class="ruby-operator">::</span><span class="ruby-constant">MD5</span>.<span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">fp</span>.<span class="ruby-identifier">read</span>)}
112: 
113:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_value</span>(<span class="ruby-node">&quot;SELECT 1 FROM posts WHERE md5 = '#{md5}'&quot;</span>)
114:                         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_f</span>(<span class="ruby-identifier">tempfile_path</span>)
115:                         <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span> <span class="ruby-value str">&quot;md5&quot;</span>, <span class="ruby-value str">&quot;already exists&quot;</span>
116:                         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
117:                 <span class="ruby-keyword kw">end</span>
118:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000081" class="method-detail">
        <a name="M000081"></a>

        <div class="method-heading">
          <a href="#M000081" class="method-signature">
          <span class="method-name">generate_preview</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000081-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000081-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 127</span>
127:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">generate_preview</span>
128:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">image?</span>
129: 
130:                 <span class="ruby-keyword kw">begin</span>
131:                         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">preview_path</span>), <span class="ruby-identifier">:mode</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0775</span>)
132: 
133:                         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">system</span>(<span class="ruby-node">&quot;#{RAILS_ROOT}/lib/resizer/resizer #{file_path} #{preview_path}&quot;</span>)
134:                                 <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span> <span class="ruby-value str">'preview'</span>, <span class="ruby-value str">&quot;couldn't be generated&quot;</span>
135:                                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
136:                         <span class="ruby-keyword kw">end</span>
137:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">x</span>
138:                         <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span> <span class="ruby-value str">'preview'</span>, <span class="ruby-node">&quot;couldn't be generated: #{x}&quot;</span>
139:                         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
140:                 <span class="ruby-keyword kw">end</span>
141:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000090" class="method-detail">
        <a name="M000090"></a>

        <div class="method-heading">
          <a href="#M000090" class="method-signature">
          <span class="method-name">get_image_dimensions</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000090-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000090-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 222</span>
222:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_image_dimensions</span>
223:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">image?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">flash?</span>
224:                         <span class="ruby-identifier">imgsize</span> = <span class="ruby-constant">ImageSize</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">file_path</span>, <span class="ruby-value str">&quot;rb&quot;</span>))
225:                         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">width</span> = <span class="ruby-identifier">imgsize</span>.<span class="ruby-identifier">get_width</span>
226:                         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">height</span> = <span class="ruby-identifier">imgsize</span>.<span class="ruby-identifier">get_height</span>
227:                 <span class="ruby-keyword kw">end</span>
228:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000091" class="method-detail">
        <a name="M000091"></a>

        <div class="method-heading">
          <a href="#M000091" class="method-signature">
          <span class="method-name">image?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if the post is an image format that GD can handle.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000091-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000091-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 231</span>
231:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">image?</span>
232:                 <span class="ruby-node">%w(jpg jpeg gif png)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file_ext</span>.<span class="ruby-identifier">downcase</span>)
233:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000099" class="method-detail">
        <a name="M000099"></a>

        <div class="method-heading">
          <a href="#M000099" class="method-signature">
          <span class="method-name">pretty_rating</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000099-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000099-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 432</span>
432:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pretty_rating</span>
433:                 <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">rating</span>
434:                 <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;q&quot;</span>
435:                         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;Questionable&quot;</span>
436: 
437:                 <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;e&quot;</span>
438:                         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;Explicit&quot;</span>
439: 
440:                 <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;s&quot;</span>
441:                         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;Safe&quot;</span>
442:                 <span class="ruby-keyword kw">end</span>
443:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000088" class="method-detail">
        <a name="M000088"></a>

        <div class="method-heading">
          <a href="#M000088" class="method-signature">
          <span class="method-name">preview_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the absolute path to the preview file.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000088-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000088-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 201</span>
201:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">preview_path</span>
202:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">image?</span>
203:                         <span class="ruby-node">&quot;#{RAILS_ROOT}/public/data/preview/%s/%s/%s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">md5</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span>[<span class="ruby-value">2</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;.jpg&quot;</span>]
204:                 <span class="ruby-keyword kw">else</span>
205:                         <span class="ruby-node">&quot;#{RAILS_ROOT}/public/data/preview/default.png&quot;</span>
206:                 <span class="ruby-keyword kw">end</span>
207:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000089" class="method-detail">
        <a name="M000089"></a>

        <div class="method-heading">
          <a href="#M000089" class="method-signature">
          <span class="method-name">preview_url</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the URL for the preview
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000089-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000089-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 210</span>
210:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">preview_url</span>
211:                 <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">method_defined?</span>(<span class="ruby-identifier">:preview_url_alt</span>)
212:                         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">preview_url_alt</span>()
213:                 <span class="ruby-keyword kw">end</span>
214: 
215:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">image?</span>
216:                         <span class="ruby-value str">&quot;http://&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">CONFIG</span>[<span class="ruby-value str">&quot;server_host&quot;</span>] <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;/data/preview/%s/%s/%s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">md5</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span>[<span class="ruby-value">2</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;.jpg&quot;</span>]
217:                 <span class="ruby-keyword kw">else</span>
218:                         <span class="ruby-value str">&quot;http://&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">CONFIG</span>[<span class="ruby-value str">&quot;server_host&quot;</span>] <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;/data/preview/default.png&quot;</span>
219:                 <span class="ruby-keyword kw">end</span>
220:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000076" class="method-detail">
        <a name="M000076"></a>

        <div class="method-heading">
          <a href="#M000076" class="method-signature">
          <span class="method-name">rating=</span><span class="method-args">(r)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000076-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000076-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/post.rb, line 44</span>
44:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">rating=</span>(<span class="ruby-identifier">r</span>)
45:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">new_record?</span>
46:                         <span class="ruby-keyword kw">return</span>
47:                 <span class="ruby-keyword kw">end</span>
48: 
49:                 <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">is_rating_locked?</span>
50:                         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span> <span class="ruby-value str">&quot;rating&quot;</span>, <span class="ruby-value str">&quot;rating is locked&quot;</span>
51:                         <span class="ruby-keyword kw">return</span>
52:                 <span class="ruby-keyword kw">end</span>
53: 
54:                 <span class="ruby-identifier">r</span> = <span class="ruby-identifier">r</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span>[<span class="ruby-value">0</span>, <span class="ruby-value">1</span>]
55: 
56:                 <span class="ruby-keyword kw">if</span> <span class="ruby-node">%w(q e s)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">r</span>)
57:                         <span class="ruby-identifier">write_attribute</span>(<span class="ruby-identifier">:rating</span>, <span class="ruby-identifier">r</span>)
58:                 <span class="ruby-keyword kw">else</span>
59:                         <span class="ruby-identifier">write_attribute</span>(<span class="ruby-identifier">:rating</span>, <span class="ruby-value str">'q'</span>)
60:                 <span class="ruby-keyword kw">end</span>
61:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000080" class="method-detail">
        <a name="M000080"></a>

        <div class="method-heading">
          <a href="#M000080" class="method-signature">
          <span class="method-name">rename_file</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000080-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000080-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 120</span>
120:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">rename_file</span>
121:                 <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">file_path</span>), <span class="ruby-identifier">:mode</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0775</span>)
122:                 <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mv</span>(<span class="ruby-identifier">tempfile_path</span>, <span class="ruby-identifier">file_path</span>)
123:                 <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">chmod</span>(<span class="ruby-value">0775</span>, <span class="ruby-identifier">file_path</span>)
124:                 <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_f</span>(<span class="ruby-identifier">tempfile_path</span>)
125:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000093" class="method-detail">
        <a name="M000093"></a>

        <div class="method-heading">
          <a href="#M000093" class="method-signature">
          <span class="method-name">size</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the <a href="Post.html#M000093">size</a> of the file in bytes (may
not be precise)
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000093-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000093-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 241</span>
241:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">size</span>
242:                 <span class="ruby-keyword kw">return</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">size</span>(<span class="ruby-identifier">file_path</span>)
243:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000075" class="method-detail">
        <a name="M000075"></a>

        <div class="method-heading">
          <a href="#M000075" class="method-signature">
          <span class="method-name">tags=</span><span class="method-args">(t)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000075-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000075-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/post.rb, line 40</span>
40:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tags=</span>(<span class="ruby-identifier">t</span>)
41:                 <span class="ruby-ivar">@tag_cache</span> = <span class="ruby-identifier">t</span> <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;&quot;</span>
42:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000078" class="method-detail">
        <a name="M000078"></a>

        <div class="method-heading">
          <a href="#M000078" class="method-signature">
          <span class="method-name">tempfile_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000078-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000078-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 105</span>
105:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tempfile_path</span>
106:                 <span class="ruby-node">&quot;#{RAILS_ROOT}/public/data/#{$$}.upload&quot;</span>
107:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000100" class="method-detail">
        <a name="M000100"></a>

        <div class="method-heading">
          <a href="#M000100" class="method-signature">
          <span class="method-name">to_json</span><span class="method-args">(options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000100-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000100-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 445</span>
445:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">to_json</span>(<span class="ruby-identifier">options</span> = {})
446:                 <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">generate_attributes</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:select</span>], <span class="ruby-identifier">:js</span>).<span class="ruby-identifier">to_json</span>
447:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000101" class="method-detail">
        <a name="M000101"></a>

        <div class="method-heading">
          <a href="#M000101" class="method-signature">
          <span class="method-name">to_xml</span><span class="method-args">(options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000101-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000101-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 449</span>
449:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">to_xml</span>(<span class="ruby-identifier">options</span> = {})
450:                 <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:indent</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">2</span>
451:                 <span class="ruby-identifier">xml</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:builder</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">Builder</span><span class="ruby-operator">::</span><span class="ruby-constant">XmlMarkup</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:indent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:indent</span>])
452:                 <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">instruct!</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:skip_instruct</span>]
453:                 <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">post</span>(<span class="ruby-identifier">generate_attributes</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:select</span>], <span class="ruby-identifier">:xml</span>))
454:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000095" class="method-detail">
        <a name="M000095"></a>

        <div class="method-heading">
          <a href="#M000095" class="method-signature">
          <span class="method-name">update_neighbor_links_on_create</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000095-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000095-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 257</span>
257:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_neighbor_links_on_create</span>
258:                 <span class="ruby-identifier">prev_post</span> = <span class="ruby-constant">Post</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;id &lt; ?&quot;</span>, <span class="ruby-identifier">id</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;id DESC&quot;</span>)
259: 
260:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">prev_post</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword kw">nil</span>
261:                         <span class="ruby-comment cmt"># should only be nil for very first post created</span>
262:                         <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;UPDATE posts SET prev_post_id = #{prev_post.id} WHERE id = #{self.id}&quot;</span>)
263:                         <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;UPDATE posts SET next_post_id = #{self.id} WHERE id = #{prev_post.id}&quot;</span>)
264:                 <span class="ruby-keyword kw">end</span>
265:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000096" class="method-detail">
        <a name="M000096"></a>

        <div class="method-heading">
          <a href="#M000096" class="method-signature">
          <span class="method-name">update_neighbor_links_on_destroy</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000096-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000096-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 267</span>
267:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_neighbor_links_on_destroy</span>
268:                 <span class="ruby-identifier">prev_post</span> = <span class="ruby-constant">Post</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;id &lt; ?&quot;</span>, <span class="ruby-identifier">id</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;id DESC&quot;</span>)
269:                 <span class="ruby-identifier">next_post</span> = <span class="ruby-constant">Post</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;id &gt; ?&quot;</span>, <span class="ruby-identifier">id</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;id ASC&quot;</span>)
270: 
271:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">prev_post</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">next_post</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
272:                         <span class="ruby-comment cmt"># do nothing</span>
273:                 <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">prev_post</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">next_post</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword kw">nil</span>
274:                         <span class="ruby-comment cmt"># deleted post is in middle</span>
275:                         <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;UPDATE posts SET next_post_id = #{next_post.id} WHERE id = #{prev_post.id}&quot;</span>)
276:                         <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;UPDATE posts SET prev_post_id = #{prev_post.id} WHERE id = #{next_post.id}&quot;</span>)
277:                 <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">prev_post</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
278:                         <span class="ruby-comment cmt"># no previous post, therefore deleted post is first post</span>
279:                         <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;UPDATE posts SET prev_post_id = NULL WHERE id = #{next_post.id}&quot;</span>)
280:                 <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">next_post</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
281:                         <span class="ruby-comment cmt"># no next post, therefore deleted post is last post</span>
282:                         <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;UPDATE posts SET next_post_id = NULL WHERE id = #{prev_post.id}&quot;</span>)
283:                 <span class="ruby-keyword kw">end</span>
284:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Protected Instance methods</h3>

      <div id="method-M000103" class="method-detail">
        <a name="M000103"></a>

        <div class="method-heading">
          <a href="#M000103" class="method-signature">
          <span class="method-name">escape_javascript</span><span class="method-args">(s)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000103-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000103-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 519</span>
519:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">escape_javascript</span>(<span class="ruby-identifier">s</span>)
520:                 <span class="ruby-identifier">s</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\\/</span>, <span class="ruby-value str">'\0\0'</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/['&quot;]/</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;\\#{m}&quot;</span>}
521:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000104" class="method-detail">
        <a name="M000104"></a>

        <div class="method-heading">
          <a href="#M000104" class="method-signature">
          <span class="method-name">find_ext</span><span class="method-args">(file_path)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000104-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000104-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 523</span>
523:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">find_ext</span>(<span class="ruby-identifier">file_path</span>)
524:                 <span class="ruby-identifier">ext</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>(<span class="ruby-identifier">file_path</span>)
525:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">ext</span>.<span class="ruby-identifier">blank?</span>
526:                         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;txt&quot;</span>
527:                 <span class="ruby-keyword kw">else</span>
528:                         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">ext</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">downcase</span>
529:                 <span class="ruby-keyword kw">end</span>
530:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000102" class="method-detail">
        <a name="M000102"></a>

        <div class="method-heading">
          <a href="#M000102" class="method-signature">
          <span class="method-name">generate_attributes</span><span class="method-args">(select_attributes, escape_method)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000102-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000102-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 457</span>
457:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">generate_attributes</span>(<span class="ruby-identifier">select_attributes</span>, <span class="ruby-identifier">escape_method</span>)
458:                 <span class="ruby-identifier">attribs</span> = {}
459:                 <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:id</span>] = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">id</span>
460:                 <span class="ruby-identifier">select_attributes</span> <span class="ruby-operator">||=</span> <span class="ruby-node">%w(tags author file)</span>
461: 
462:                 <span class="ruby-identifier">select_attributes</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">attr</span><span class="ruby-operator">|</span>
463:                         <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">attr</span>
464:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;created_at&quot;</span>
465:                         <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:created_at</span>] = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">created_at</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-value str">&quot;%D %T&quot;</span>)
466: 
467:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;source&quot;</span>
468:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">escape_method</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:xml</span>
469:                                 <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:source</span>] = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">escapeHTML</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">source</span>)
470:                         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">escape_method</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:js</span>
471:                                 <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:source</span>] = <span class="ruby-identifier">escape_javascript</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">source</span>)
472:                         <span class="ruby-keyword kw">else</span>
473:                                 <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:source</span>] = <span class="ruby-identifier">source</span>
474:                         <span class="ruby-keyword kw">end</span>
475: 
476:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;author&quot;</span>
477:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">escape_method</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:xml</span>
478:                                 <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:author</span>] = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">escapeHTML</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">author</span>)
479:                         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">escape_method</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:js</span>
480:                                 <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:author</span>] = <span class="ruby-identifier">escape_javascript</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">author</span>)
481:                         <span class="ruby-keyword kw">else</span>
482:                                 <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:author</span>] = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">author</span>
483:                         <span class="ruby-keyword kw">end</span>
484: 
485:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;score&quot;</span>
486:                         <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:score</span>] = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">score</span>
487: 
488:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;md5&quot;</span>
489:                         <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:md5</span>] = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">md5</span>
490: 
491:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;preview&quot;</span>
492:                         <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:preview</span>] = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">preview_url</span>
493: 
494:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;file&quot;</span>
495:                         <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:file</span>] = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file_url</span>
496: 
497:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;rating&quot;</span>
498:                         <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:rating</span>] = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">pretty_rating</span>
499: 
500:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;tags&quot;</span>
501:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">escape_method</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:xml</span>
502:                                 <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:tags</span>] = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">escapeHTML</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">cached_tags</span>)
503:                         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">escape_method</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:js</span>
504:                                 <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:tags</span>] = <span class="ruby-identifier">escape_javascript</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">cached_tags</span>)
505:                         <span class="ruby-keyword kw">end</span>
506: 
507:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;next&quot;</span>
508:                         <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:next</span>] = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">next_post_id</span>
509: 
510:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;previous&quot;</span>
511:                         <span class="ruby-identifier">attribs</span>[<span class="ruby-identifier">:previous</span>] = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">prev_post_id</span>
512: 
513:                         <span class="ruby-keyword kw">end</span>
514:                 <span class="ruby-keyword kw">end</span>
515: 
516:                 <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">attribs</span>
517:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>