<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: Post</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">Post</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/models/post_rb.html">
                app/models/post.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                ActiveRecord::Base
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000085">author</a>&nbsp;&nbsp;
      <a href="#M000074">auto_download</a>&nbsp;&nbsp;
      <a href="#M000073">delete_file</a>&nbsp;&nbsp;
      <a href="#M000066">fast_count</a>&nbsp;&nbsp;
      <a href="#M000075">file=</a>&nbsp;&nbsp;
      <a href="#M000076">file_name</a>&nbsp;&nbsp;
      <a href="#M000077">file_path</a>&nbsp;&nbsp;
      <a href="#M000078">file_url</a>&nbsp;&nbsp;
      <a href="#M000083">flash?</a>&nbsp;&nbsp;
      <a href="#M000070">generate_hash</a>&nbsp;&nbsp;
      <a href="#M000072">generate_preview</a>&nbsp;&nbsp;
      <a href="#M000086">generate_sql</a>&nbsp;&nbsp;
      <a href="#M000081">get_image_dimensions</a>&nbsp;&nbsp;
      <a href="#M000082">image?</a>&nbsp;&nbsp;
      <a href="#M000087">pretty_rating</a>&nbsp;&nbsp;
      <a href="#M000079">preview_path</a>&nbsp;&nbsp;
      <a href="#M000080">preview_url</a>&nbsp;&nbsp;
      <a href="#M000067">rate!</a>&nbsp;&nbsp;
      <a href="#M000071">rename_file</a>&nbsp;&nbsp;
      <a href="#M000084">size</a>&nbsp;&nbsp;
      <a href="#M000068">tag!</a>&nbsp;&nbsp;
      <a href="#M000069">tempfile_path</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->
    <div id="includes">
      <h3 class="section-bar">Included Modules</h3>

      <div id="includes-list">
        <span class="include-name">MimeTypes</span>
      </div>
    </div>

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000066" class="method-detail">
        <a name="M000066"></a>

        <div class="method-heading">
          <a href="#M000066" class="method-signature">
          <span class="method-name">fast_count</span><span class="method-args">(tags = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000066-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000066-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/post.rb, line 19</span>
19:         <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">fast_count</span>(<span class="ruby-identifier">tags</span> = <span class="ruby-keyword kw">nil</span>)
20:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">blank?</span>
21:                         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_value</span>(<span class="ruby-value str">&quot;SELECT row_count FROM table_data WHERE name = 'posts'&quot;</span>).<span class="ruby-identifier">to_i</span>
22:                 <span class="ruby-keyword kw">else</span>
23:                         <span class="ruby-identifier">c</span> = <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_value</span>(<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-value str">&quot;SELECT post_count FROM tags WHERE name = ?&quot;</span>, <span class="ruby-identifier">tags</span>])).<span class="ruby-identifier">to_i</span>
24:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
25:                                 <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Post</span>.<span class="ruby-identifier">count_by_sql</span>(<span class="ruby-constant">Post</span>.<span class="ruby-identifier">generate_sql</span>(<span class="ruby-identifier">tags</span>, <span class="ruby-identifier">:count</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>))
26:                         <span class="ruby-keyword kw">else</span>
27:                                 <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">c</span>
28:                         <span class="ruby-keyword kw">end</span>
29:                 <span class="ruby-keyword kw">end</span>
30:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000086" class="method-detail">
        <a name="M000086"></a>

        <div class="method-heading">
          <a href="#M000086" class="method-signature">
          <span class="method-name">generate_sql</span><span class="method-args">(q, options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000086-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000086-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 222</span>
222:         <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">generate_sql</span>(<span class="ruby-identifier">q</span>, <span class="ruby-identifier">options</span> = {})
223:                 <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">q</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>)
224:                         <span class="ruby-identifier">q</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">parse_query</span>(<span class="ruby-identifier">q</span>)
225:                 <span class="ruby-keyword kw">end</span>
226: 
227:                 <span class="ruby-identifier">conditions</span> = []
228:                 <span class="ruby-identifier">from</span> = [<span class="ruby-value str">&quot;posts p&quot;</span>]
229:                 <span class="ruby-identifier">params</span> = []
230: 
231:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:after_id</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>)
232:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.id &gt; ?&quot;</span>
233:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:after_id</span>]
234:                 <span class="ruby-keyword kw">end</span>
235: 
236:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:md5</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
237:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.md5 = ?&quot;</span>
238:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:md5</span>]
239:                 <span class="ruby-keyword kw">end</span>
240: 
241:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:width</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>)
242:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;p.width #{q[:widthop]} ?&quot;</span>
243:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:width</span>]
244:                 <span class="ruby-keyword kw">end</span>
245: 
246:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:height</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>)
247:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;p.height #{q[:heightop]} ?&quot;</span>
248:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:height</span>]
249:                 <span class="ruby-keyword kw">end</span>
250: 
251:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:source</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
252:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.source LIKE ? ESCAPE '\\\\'&quot;</span>
253:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:source</span>]
254:                 <span class="ruby-keyword kw">end</span>
255: 
256:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:fav</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
257:                         <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;favorites f&quot;</span>
258:                         <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;users u1&quot;</span>
259:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.id = f.post_id AND f.user_id = u1.id AND lower(u1.name) = lower(?)&quot;</span>
260:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:fav</span>]
261:                 <span class="ruby-keyword kw">end</span>
262: 
263:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:user</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
264:                         <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;users u2&quot;</span>
265:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.user_id = u2.id AND lower(u2.name) = lower(?)&quot;</span>
266:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:user</span>]
267:                 <span class="ruby-keyword kw">end</span>
268: 
269:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>].<span class="ruby-identifier">any?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:include</span>].<span class="ruby-identifier">any?</span>
270:                         <span class="ruby-identifier">conditions2</span> = []
271:                         
272:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:include</span>].<span class="ruby-identifier">any?</span>
273:                                 <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;posts_tags pt0&quot;</span>
274:                                 <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;tags t0&quot;</span>
275:                                 <span class="ruby-identifier">conditions2</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;(p.id = pt0.post_id AND t0.id = pt0.tag_id AND t0.name IN (?))&quot;</span>
276:                                 <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">q</span>[<span class="ruby-identifier">:include</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>])
277:                         <span class="ruby-keyword kw">else</span>
278:                                 <span class="ruby-identifier">conditions3</span> = []
279: 
280:                                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>].<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
281:                                         <span class="ruby-identifier">count</span> = <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_value</span>(<span class="ruby-constant">Post</span>.<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-value str">&quot;SELECT post_count FROM tags WHERE name = ?&quot;</span>, <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>][<span class="ruby-value">0</span>]])).<span class="ruby-identifier">to_i</span>
282:                                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">count</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">100</span>
283:                                                 <span class="ruby-comment cmt"># 96% of the tags have a post count below 100. it makes sense to optimize for this common case, then.</span>
284:                                                 <span class="ruby-comment cmt"># for tags with low post counts, using &quot;p.id in (...)&quot; is much faster than relying on a join.</span>
285:                                                 <span class="ruby-identifier">conditions3</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.id IN (SELECT pt1.post_id FROM posts_tags pt1 WHERE pt1.tag_id = (SELECT id FROM tags WHERE name = ?))&quot;</span>
286:                                         <span class="ruby-keyword kw">else</span>
287:                                                 <span class="ruby-comment cmt"># On the other hand, for extremely populated tags (the top 5%) this method is much faster.</span>
288:                                                 <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;posts_tags pt1&quot;</span>
289:                                                 <span class="ruby-identifier">conditions3</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.id = pt1.post_id AND pt1.tag_id = (SELECT id FROM tags WHERE name = ?)&quot;</span>
290:                                         <span class="ruby-keyword kw">end</span>
291:                                 <span class="ruby-keyword kw">else</span>
292:                                         (<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>].<span class="ruby-identifier">size</span>).<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">from</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;posts_tags pt#{i}&quot;</span>}
293:                                         <span class="ruby-identifier">conditions3</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.id = pt1.post_id&quot;</span>
294:                                         (<span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>].<span class="ruby-identifier">size</span>).<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">conditions3</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;pt1.post_id = pt#{i}.post_id&quot;</span>}
295:                                         (<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>].<span class="ruby-identifier">size</span>).<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">conditions3</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;pt#{i}.tag_id = (SELECT id FROM tags WHERE name = ?)&quot;</span>}
296:                                 <span class="ruby-keyword kw">end</span>
297: 
298:                                 <span class="ruby-identifier">params</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:related</span>]
299:                                 <span class="ruby-identifier">conditions2</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;(&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">conditions3</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot; AND &quot;</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;)&quot;</span>
300:                         <span class="ruby-keyword kw">end</span>
301: 
302:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;(&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">conditions2</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot; OR &quot;</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;)&quot;</span>
303:                 <span class="ruby-keyword kw">end</span>
304: 
305:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:exclude</span>].<span class="ruby-identifier">any?</span>
306:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.id NOT IN (SELECT pt_.post_id FROM posts_tags pt_, tags t_ WHERE pt_.tag_id = t_.id AND t_.name IN (?))&quot;</span>
307:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:exclude</span>]
308:                 <span class="ruby-keyword kw">end</span>
309: 
310:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:score</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>)
311:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;p.score #{q[:scoreop]} ?&quot;</span>
312:                         <span class="ruby-identifier">params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:score</span>]
313:                 <span class="ruby-keyword kw">end</span>
314: 
315:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:rating</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
316:                         <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">q</span>[<span class="ruby-identifier">:rating</span>].<span class="ruby-identifier">downcase</span>
317:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;safe&quot;</span>
318:                                 <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.rating = 's'&quot;</span>
319: 
320:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;questionable&quot;</span>
321:                                 <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.rating = 'q'&quot;</span>
322: 
323:                         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;explicit&quot;</span>
324:                                 <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.rating = 'e'&quot;</span>
325:                         <span class="ruby-keyword kw">end</span>
326:                 <span class="ruby-keyword kw">end</span>
327: 
328:                 <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:with_unwarehoused</span>]
329:                         <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.is_warehoused = TRUE&quot;</span>
330:                 <span class="ruby-keyword kw">end</span>
331: 
332:                 <span class="ruby-identifier">sql</span> = <span class="ruby-value str">&quot;SELECT &quot;</span>
333:                 
334:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:count</span>]
335:                         <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;COUNT(p)&quot;</span>
336:                 <span class="ruby-keyword kw">else</span>
337:                         <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;p.*&quot;</span>
338:                 <span class="ruby-keyword kw">end</span>
339: 
340:                 <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; FROM &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">from</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;, &quot;</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; WHERE &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot; AND &quot;</span>)
341: 
342:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:order</span>]
343:                         <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; ORDER BY &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:order</span>]
344:                 <span class="ruby-keyword kw">end</span>
345: 
346:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:limit</span>]
347:                         <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; LIMIT &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:limit</span>].<span class="ruby-identifier">to_s</span>
348:                 <span class="ruby-keyword kw">end</span>
349: 
350:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:offset</span>]
351:                         <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; OFFSET &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:offset</span>].<span class="ruby-identifier">to_s</span>
352:                 <span class="ruby-keyword kw">end</span>
353: 
354:                 <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Post</span>.<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-identifier">sql</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">params</span>])
355:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000085" class="method-detail">
        <a name="M000085"></a>

        <div class="method-heading">
          <a href="#M000085" class="method-signature">
          <span class="method-name">author</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns either the <a href="Post.html#M000085">author</a>&#8216;s name or
the default guest name.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000085-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000085-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 211</span>
211:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">author</span>
212:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@author</span>
213:                         <span class="ruby-ivar">@author</span>
214:                 <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">user_id</span>
215:                         <span class="ruby-ivar">@author</span> = <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_value</span>(<span class="ruby-node">&quot;SELECT name FROM users WHERE id = #{self.user_id}&quot;</span>)
216:                         <span class="ruby-ivar">@author</span>
217:                 <span class="ruby-keyword kw">else</span>
218:                         <span class="ruby-constant">CONFIG</span>[<span class="ruby-value str">&quot;default_guest_name&quot;</span>]
219:                 <span class="ruby-keyword kw">end</span>
220:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000074" class="method-detail">
        <a name="M000074"></a>

        <div class="method-heading">
          <a href="#M000074" class="method-signature">
          <span class="method-name">auto_download</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
<a href="Post.html#M000074">auto_download</a> automatically downloads from
the source url if it&#8216;s a URL
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000074-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000074-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 116</span>
116:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">auto_download</span>
117:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">source</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^http/</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">file_ext</span>.<span class="ruby-identifier">blank?</span>)
118: 
119:                 <span class="ruby-keyword kw">begin</span>
120:                         <span class="ruby-identifier">img</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">get</span>(<span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">source</span>))
121:                         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file_ext</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>(<span class="ruby-identifier">source</span>)[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
122:                         <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">tempfile_path</span>, <span class="ruby-value str">'wb'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">out</span><span class="ruby-operator">|</span>
123:                                 <span class="ruby-identifier">out</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">img</span>)
124:                         <span class="ruby-keyword kw">end</span>
125:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">x</span>
126:                         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_f</span>(<span class="ruby-identifier">tempfile_path</span>)
127:                         <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span> <span class="ruby-value str">&quot;source&quot;</span>, <span class="ruby-node">&quot;couldn't be opened: #{x}&quot;</span>
128:                         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
129:                 <span class="ruby-keyword kw">end</span>
130:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000073" class="method-detail">
        <a name="M000073"></a>

        <div class="method-heading">
          <a href="#M000073" class="method-signature">
          <span class="method-name">delete_file</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
<a href="Post.html#M000073">delete_file</a> removes the post and its
preview from the file system.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000073-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000073-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 110</span>
110:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_file</span>
111:                 <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_f</span>(<span class="ruby-identifier">file_path</span>)
112:                 <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_f</span>(<span class="ruby-identifier">preview_path</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">image?</span>
113:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000075" class="method-detail">
        <a name="M000075"></a>

        <div class="method-heading">
          <a href="#M000075" class="method-signature">
          <span class="method-name">file=</span><span class="method-args">(f)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
<a href="Post.html#M000075">file=</a> assigns a CGI file to the post. This
writes the file to disk and generates a unique file name.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000075-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000075-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 133</span>
133:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">file=</span>(<span class="ruby-identifier">f</span>)
134:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
135: 
136:                 <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file_ext</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>(<span class="ruby-identifier">f</span>.<span class="ruby-identifier">original_filename</span>)[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">downcase</span>
137: 
138:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">local_path</span>
139:                         <span class="ruby-comment cmt"># Large files are stored in the temp directory, so instead of</span>
140:                         <span class="ruby-comment cmt"># reading/rewriting through Ruby, just rely on system calls to</span>
141:                         <span class="ruby-comment cmt"># copy the file to danbooru's directory.</span>
142:                         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">cp</span>(<span class="ruby-identifier">f</span>.<span class="ruby-identifier">local_path</span>, <span class="ruby-identifier">tempfile_path</span>)
143:                 <span class="ruby-keyword kw">else</span>
144:                         <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">tempfile_path</span>, <span class="ruby-value str">'wb'</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">nf</span><span class="ruby-operator">|</span> <span class="ruby-identifier">nf</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span>)}
145:                 <span class="ruby-keyword kw">end</span>
146:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000076" class="method-detail">
        <a name="M000076"></a>

        <div class="method-heading">
          <a href="#M000076" class="method-signature">
          <span class="method-name">file_name</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000076-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000076-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 148</span>
148:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">file_name</span>
149:                 <span class="ruby-identifier">md5</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;.&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">file_ext</span>
150:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000077" class="method-detail">
        <a name="M000077"></a>

        <div class="method-heading">
          <a href="#M000077" class="method-signature">
          <span class="method-name">file_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the absolute path to the post.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000077-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000077-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 153</span>
153:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">file_path</span>
154:                 <span class="ruby-node">&quot;#{RAILS_ROOT}/public/data/%s/%s/%s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">md5</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span>[<span class="ruby-value">2</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">file_name</span>]
155:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000078" class="method-detail">
        <a name="M000078"></a>

        <div class="method-heading">
          <a href="#M000078" class="method-signature">
          <span class="method-name">file_url</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the URL for the post
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000078-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000078-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 158</span>
158:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">file_url</span>
159:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">is_warehoused?</span>
160:                         <span class="ruby-node">&quot;http://#{Server.select_random_url}%s/%s/%s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">md5</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span>[<span class="ruby-value">2</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">file_name</span>]
161:                 <span class="ruby-keyword kw">else</span>
162:                         <span class="ruby-value str">&quot;http://&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">CONFIG</span>[<span class="ruby-value str">&quot;server_host&quot;</span>] <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;/data/%s/%s/%s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">md5</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span>[<span class="ruby-value">2</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">file_name</span>]
163:                 <span class="ruby-keyword kw">end</span>
164:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000083" class="method-detail">
        <a name="M000083"></a>

        <div class="method-heading">
          <a href="#M000083" class="method-signature">
          <span class="method-name">flash?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if the post is a Flash movie.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000083-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000083-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 201</span>
201:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">flash?</span>
202:                 <span class="ruby-identifier">file_ext</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;swf&quot;</span>
203:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000070" class="method-detail">
        <a name="M000070"></a>

        <div class="method-heading">
          <a href="#M000070" class="method-signature">
          <span class="method-name">generate_hash</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Generates a MD5 hash for the file
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000070-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000070-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/post.rb, line 76</span>
76:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">generate_hash</span>
77:                 <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">md5</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">tempfile_path</span>, <span class="ruby-value str">'rb'</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">fp</span><span class="ruby-operator">|</span> <span class="ruby-constant">Digest</span><span class="ruby-operator">::</span><span class="ruby-constant">MD5</span>.<span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">fp</span>.<span class="ruby-identifier">read</span>)}
78: 
79:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_value</span>(<span class="ruby-node">&quot;SELECT 1 FROM posts WHERE md5 = '#{md5}'&quot;</span>)
80:                         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_f</span>(<span class="ruby-identifier">tempfile_path</span>)
81:                         <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span> <span class="ruby-value str">&quot;md5&quot;</span>, <span class="ruby-value str">&quot;already exists&quot;</span>
82:                         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
83:                 <span class="ruby-keyword kw">end</span>
84:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000072" class="method-detail">
        <a name="M000072"></a>

        <div class="method-heading">
          <a href="#M000072" class="method-signature">
          <span class="method-name">generate_preview</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000072-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000072-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 93</span>
 93:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">generate_preview</span>
 94:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">image?</span>
 95: 
 96:                 <span class="ruby-keyword kw">begin</span>
 97:                         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">preview_path</span>), <span class="ruby-identifier">:mode</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0775</span>)
 98: 
 99:                         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">system</span>(<span class="ruby-node">&quot;#{RAILS_ROOT}/lib/resizer/resizer #{file_path} #{preview_path}&quot;</span>)
100:                                 <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span> <span class="ruby-value str">'preview'</span>, <span class="ruby-node">&quot;couldn't be generated. error code=#{err}&quot;</span>
101:                                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
102:                         <span class="ruby-keyword kw">end</span>
103:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">x</span>
104:                         <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span> <span class="ruby-value str">'preview'</span>, <span class="ruby-node">&quot;couldn't be generated: #{x}&quot;</span>
105:                         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
106:                 <span class="ruby-keyword kw">end</span>
107:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000081" class="method-detail">
        <a name="M000081"></a>

        <div class="method-heading">
          <a href="#M000081" class="method-signature">
          <span class="method-name">get_image_dimensions</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000081-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000081-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 187</span>
187:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_image_dimensions</span>
188:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">image?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">flash?</span>
189:                         <span class="ruby-identifier">imgsize</span> = <span class="ruby-constant">ImageSize</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">file_path</span>, <span class="ruby-value str">&quot;rb&quot;</span>))
190:                         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">width</span> = <span class="ruby-identifier">imgsize</span>.<span class="ruby-identifier">get_width</span>
191:                         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">height</span> = <span class="ruby-identifier">imgsize</span>.<span class="ruby-identifier">get_height</span>
192:                 <span class="ruby-keyword kw">end</span>
193:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000082" class="method-detail">
        <a name="M000082"></a>

        <div class="method-heading">
          <a href="#M000082" class="method-signature">
          <span class="method-name">image?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if the post is an image format that GD can handle.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000082-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000082-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 196</span>
196:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">image?</span>
197:                 <span class="ruby-node">%w(jpg jpeg gif png)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">file_ext</span>)
198:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000087" class="method-detail">
        <a name="M000087"></a>

        <div class="method-heading">
          <a href="#M000087" class="method-signature">
          <span class="method-name">pretty_rating</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000087-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000087-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 357</span>
357:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pretty_rating</span>
358:                 <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">rating</span>
359:                 <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;q&quot;</span>
360:                         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;Questionable&quot;</span>
361: 
362:                 <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;e&quot;</span>
363:                         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;Explicit&quot;</span>
364: 
365:                 <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;s&quot;</span>
366:                         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;Safe&quot;</span>
367:                 <span class="ruby-keyword kw">end</span>
368:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000079" class="method-detail">
        <a name="M000079"></a>

        <div class="method-heading">
          <a href="#M000079" class="method-signature">
          <span class="method-name">preview_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the absolute path to the preview file.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000079-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000079-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 167</span>
167:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">preview_path</span>
168:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">image?</span>
169:                         <span class="ruby-node">&quot;#{RAILS_ROOT}/public/data/preview/%s/%s/%s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">md5</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span>[<span class="ruby-value">2</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;.jpg&quot;</span>]
170:                 <span class="ruby-keyword kw">else</span>
171:                         <span class="ruby-node">&quot;#{RAILS_ROOT}/public/data/preview/default.png&quot;</span>
172:                 <span class="ruby-keyword kw">end</span>
173:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000080" class="method-detail">
        <a name="M000080"></a>

        <div class="method-heading">
          <a href="#M000080" class="method-signature">
          <span class="method-name">preview_url</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the URL for the preview
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000080-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000080-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 176</span>
176:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">preview_url</span>
177:                 <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">image?</span>
178:                         <span class="ruby-value str">&quot;http://&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">CONFIG</span>[<span class="ruby-value str">&quot;server_host&quot;</span>] <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;/data/preview/default.png&quot;</span>
179:                 <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">is_warehoused?</span>
180: <span class="ruby-comment cmt">#                       &quot;http://&quot; + Server.select_random_url + &quot;preview/%s/%s/%s&quot; % [md5[0,2], md5[2,2], md5 + &quot;.jpg&quot;]</span>
181:                         <span class="ruby-value str">&quot;http://mapored.net/~danbooru/data/preview/%s/%s/%s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">md5</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span>[<span class="ruby-value">2</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;.jpg&quot;</span>]
182:                 <span class="ruby-keyword kw">else</span>
183:                         <span class="ruby-value str">&quot;http://&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">CONFIG</span>[<span class="ruby-value str">&quot;server_host&quot;</span>] <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;/data/preview/%s/%s/%s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">md5</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span>[<span class="ruby-value">2</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">md5</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;.jpg&quot;</span>]
184:                 <span class="ruby-keyword kw">end</span>
185:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000067" class="method-detail">
        <a name="M000067"></a>

        <div class="method-heading">
          <a href="#M000067" class="method-signature">
          <span class="method-name">rate!</span><span class="method-args">(rating)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000067-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000067-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/post.rb, line 32</span>
32:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">rate!</span>(<span class="ruby-identifier">rating</span>)
33:                 <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">is_rating_locked?</span>
34:                         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span> <span class="ruby-value str">&quot;rating&quot;</span>, <span class="ruby-value str">&quot;rating is locked&quot;</span>
35:                         <span class="ruby-keyword kw">return</span>
36:                 <span class="ruby-keyword kw">end</span>
37: 
38:                 <span class="ruby-identifier">rating</span> = <span class="ruby-identifier">rating</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span>[<span class="ruby-value">0</span>,<span class="ruby-value">1</span>]
39:                 <span class="ruby-keyword kw">if</span> <span class="ruby-node">%w(q e s)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">rating</span>)
40:                         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">rating</span> = <span class="ruby-identifier">rating</span>
41:                 <span class="ruby-keyword kw">else</span>
42:                         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">rating</span> = <span class="ruby-value str">'q'</span>
43:                 <span class="ruby-keyword kw">end</span>
44:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000071" class="method-detail">
        <a name="M000071"></a>

        <div class="method-heading">
          <a href="#M000071" class="method-signature">
          <span class="method-name">rename_file</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000071-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000071-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/post.rb, line 86</span>
86:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">rename_file</span>
87:                 <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">file_path</span>), <span class="ruby-identifier">:mode</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0775</span>)
88:                 <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mv</span>(<span class="ruby-identifier">tempfile_path</span>, <span class="ruby-identifier">file_path</span>)
89:                 <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">chmod</span>(<span class="ruby-value">0775</span>, <span class="ruby-identifier">file_path</span>)
90:                 <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_f</span>(<span class="ruby-identifier">tempfile_path</span>)
91:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000084" class="method-detail">
        <a name="M000084"></a>

        <div class="method-heading">
          <a href="#M000084" class="method-signature">
          <span class="method-name">size</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the <a href="Post.html#M000084">size</a> of the file in bytes (may
not be precise)
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000084-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000084-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/post.rb, line 206</span>
206:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">size</span>
207:                 <span class="ruby-keyword kw">return</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">size</span>(<span class="ruby-identifier">file_path</span>)
208:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000068" class="method-detail">
        <a name="M000068"></a>

        <div class="method-heading">
          <a href="#M000068" class="method-signature">
          <span class="method-name">tag!</span><span class="method-args">(tags)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Saves the tags to the join table.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000068-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000068-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/post.rb, line 47</span>
47:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tag!</span>(<span class="ruby-identifier">tags</span>)
48:                 <span class="ruby-identifier">tags</span> = <span class="ruby-value str">&quot;tagme&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">blank?</span>
49:                 
50:                 <span class="ruby-identifier">canonical</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">scan_tags</span>(<span class="ruby-identifier">tags</span>)
51:                 <span class="ruby-identifier">canonical</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">to_aliased</span>(<span class="ruby-identifier">canonical</span>).<span class="ruby-identifier">uniq</span>
52:                 <span class="ruby-identifier">canonical</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">with_parents</span>(<span class="ruby-identifier">canonical</span>).<span class="ruby-identifier">uniq</span>
53: 
54:                 <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-value str">&quot;BEGIN&quot;</span>)
55:                 <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;DELETE FROM posts_tags WHERE post_id = #{id}&quot;</span>)
56:                 <span class="ruby-identifier">canonical</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
57:                         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_value</span>(<span class="ruby-constant">Post</span>.<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-value str">&quot;SELECT 1 FROM tags WHERE name = ?&quot;</span>, <span class="ruby-identifier">t</span>]))
58:                                 <span class="ruby-identifier">tag_type</span> = (<span class="ruby-identifier">t</span>[<span class="ruby-regexp re">/_\(artist\)$/</span>] <span class="ruby-operator">?</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>)
59:                                 <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-constant">Post</span>.<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-value str">&quot;INSERT INTO tags (name, tag_type) VALUES (?, ?)&quot;</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">tag_type</span>]))
60:                         <span class="ruby-keyword kw">end</span>
61:                         <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-constant">Post</span>.<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-node">&quot;INSERT INTO posts_tags (post_id, tag_id) VALUES (#{id}, (SELECT id FROM tags WHERE name = ?))&quot;</span>, <span class="ruby-identifier">t</span>]))
62:                 <span class="ruby-keyword kw">end</span>
63:                 
64:                 <span class="ruby-identifier">foo</span> = <span class="ruby-identifier">canonical</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot; &quot;</span>)
65: 
66:                 <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-constant">Post</span>.<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-node">&quot;INSERT INTO post_tag_histories (post_id, tags) VALUES (#{id}, ?)&quot;</span>, <span class="ruby-identifier">foo</span>]))
67:                 <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-constant">Post</span>.<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-node">&quot;UPDATE posts SET cached_tags = ? WHERE id = #{id}&quot;</span>, <span class="ruby-identifier">foo</span>]))
68:                 <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-value str">&quot;COMMIT&quot;</span>)
69:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000069" class="method-detail">
        <a name="M000069"></a>

        <div class="method-heading">
          <a href="#M000069" class="method-signature">
          <span class="method-name">tempfile_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000069-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000069-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/post.rb, line 71</span>
71:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tempfile_path</span>
72:                 <span class="ruby-node">&quot;#{RAILS_ROOT}/public/data/#{$$}.upload&quot;</span>
73:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>